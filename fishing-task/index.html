<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fishing Task - Seasonal Edition</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f0f4f8; display: flex; height: 100vh; }
        
        /* Layout */
        #sidebar { width: 300px; background: #fff; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: auto; z-index: 10; }
        #game-container { flex-grow: 1; position: relative; background: linear-gradient(to bottom, #87CEEB, #1E90FF); overflow: hidden; cursor: crosshair; height: 100vh; }
        
        /* Sidebar Styling */
        .control-group { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        label { display: block; font-weight: bold; font-size: 0.9em; margin-bottom: 5px; }
        input[type="range"] { width: 100%; }
        .value-display { float: right; color: #007bff; }
        .season-option { display: flex; align-items: center; gap: 8px; font-weight: normal; font-size: 0.85em; margin-bottom: 3px; cursor: pointer; }
        
        button { width: 100%; padding: 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; margin-top: 10px; }
        button#stop-btn { background: #dc3545; display: none; }

        /* HUD & UI */
        #hud { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; color: white; font-size: 1.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); pointer-events: none; z-index: 5; }
        /* TRAVEL BUTTON - Positioned on the right side */
        #travel-btn { 
            position: absolute; 
            top: 50%; /* Center it vertically */
            right: 20px; /* Gap from the right edge */
            transform: translateY(-50%); /* Perfect vertical centering */
            
            width: auto; /* Prevents stretching */
            padding: 20px 15px; 
            
            /* Look and Feel */
            background: #FFD700; 
            color: #333;
            border: 3px solid #DAA520; 
            border-radius: 50px; /* Makes it a pill/oval shape */
            
            /* Text layout */
            writing-mode: vertical-rl; /* Optional: makes text read top-to-bottom */
            text-orientation: mixed;
            font-weight: bold; 
            font-size: 1em; 
            
            cursor: pointer; 
            z-index: 100; 
            box-shadow: -4px 4px 8px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
            
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        #travel-btn:hover {
            background: #FFF;
            right: 15px; /* Slight move on hover */
        }
        
        #travel-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        /* Entities */
        .entity { position: absolute; width: 80px; height: 80px; background-size: contain; background-repeat: no-repeat; cursor: pointer; user-select: none; z-index: 10; }

        /* Loading Bar & Overlay */
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 200; text-align: center; }
        #loading-bar-container { width: 60%; height: 20px; background: #444; border-radius: 10px; overflow: hidden; margin: 20px auto; display: none; }
        #loading-bar-fill { width: 0%; height: 100%; background: #FFD700; }
        #transition-gif { width: 200px; display: none; margin-bottom: 20px; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Experiment Config</h2>
        
        <div class="control-group">
            <label>Base Spawn Speed (ms) <span id="val-rate" class="value-display">800</span></label>
            <input type="range" id="param-rate" min="400" max="2000" step="100" value="800">
            <small style="color: #666;">Controls the "speed" of the seasons.</small>
        </div>

        <div class="control-group">
            <label>Environment Season</label>
            <label class="season-option"><input type="radio" name="season" value="manual" checked> ‚öôÔ∏è Manual (Use Sliders)</label>
            <label class="season-option"><input type="radio" name="season" value="spring"> üå∏ Spring (Increasing Fish)</label>
            <label class="season-option"><input type="radio" name="season" value="summer"> ‚òÄÔ∏è Summer (Constant High)</label>
            <label class="season-option"><input type="radio" name="season" value="fall"> üçÇ Fall (Decreasing Fish)</label>
            <label class="season-option"><input type="radio" name="season" value="winter"> ‚ùÑÔ∏è Winter (Constant Low)</label>
        </div>

        <div class="control-group" id="manual-ratio-group">
            <label>Trash Ratio (%) <span id="val-ratio" class="value-display">30</span></label>
            <input type="range" id="param-ratio" min="0" max="100" value="30">
        </div>

        <div class="control-group">
            <label>Max Fish per Pond <span id="val-max-fish" class="value-display">10</span></label>
            <input type="range" id="param-max-fish" min="1" max="50" value="10">
        </div>

        <div class="control-group">
            <label>Total Game Time (s) <span id="val-time" class="value-display">60</span></label>
            <input type="range" id="param-time" min="10" max="600" step="10" value="60">
        </div>

        <div class="control-group">
            <label>Travel Cost (s) <span id="val-travel" class="value-display">2</span></label>
            <input type="range" id="param-travel" min="0" max="10" step="1" value="2">
        </div>

        <button id="start-btn" onclick="startGame()">Start Experiment</button>
        <button id="stop-btn" onclick="stopGame()">Stop Game</button>
    </div>

    <div id="game-container">
        <div id="hud">
            <div>Score: <span id="score">0</span></div>
            <div>Pond: <span id="pond-count">1</span></div>
            <div>Time: <span id="timer">00:00</span></div>
        </div>

        <button id="travel-btn" onclick="manualTravel()">
            LEAVE <br> POND <br> &rarr;
        </button>

        <div id="overlay">
            <div id="message-box">
                <img id="transition-gif" src="rowing.gif">
                <h1 id="overlay-title">Ready?</h1>
                <p id="overlay-desc"></p>
                
                <div id="loading-bar-container">
                    <div id="loading-bar-fill"></div>
                </div>

                <button id="next-pond-btn" onclick="nextPond()" style="display:none;">Enter New Pond</button>
                <button id="close-overlay-btn" onclick="closeOverlay()" style="display:none;">Close</button>
            </div>
        </div>
    </div>

    <audio id="snd-happy" src="happy.mp3" preload="auto"></audio> 
    <audio id="snd-sad" src="sad.mp3" preload="auto"></audio>

    <script>
        let gameActive = false;
        let score = 0;
        let timeLeft = 0;
        let currentPond = 1;
        let fishCaughtInPond = 0;
        let pondEntryTime = 0;
        let gameTimerInterval, fishInterval, bootInterval;

        // UI Updaters
        document.querySelectorAll('input[type="range"]').forEach(input => {
            input.addEventListener('input', (e) => {
                const displayId = e.target.id.replace('param-', 'val-');
                if(document.getElementById(displayId)) {
                    document.getElementById(displayId).innerText = e.target.value;
                }
            });
        });

        function startGame() {
            if(gameActive) return;
            score = 0; currentPond = 1; fishCaughtInPond = 0;
            timeLeft = parseInt(document.getElementById('param-time').value);
            updateHUD();
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'block';
            gameActive = true;
            gameTimerInterval = setInterval(gameLoop, 1000);
            startSpawner();
        }

        function stopGame() {
            gameActive = false;
            clearInterval(gameTimerInterval);
            clearInterval(fishInterval);
            clearInterval(bootInterval);
            document.querySelectorAll('.entity').forEach(e => e.remove());
            document.getElementById('start-btn').style.display = 'block';
            document.getElementById('stop-btn').style.display = 'none';
        }

        // THE ENGINE: TWO SEPARATE TIMERS
        function startSpawner() {
            if(fishInterval) clearInterval(fishInterval);
            if(bootInterval) clearInterval(bootInterval);

            const baseRate = parseInt(document.getElementById('param-rate').value);
            const season = document.querySelector('input[name="season"]:checked').value;

            // 1. BOOTS: Constant rate (Baseline trash in the pond)
            // We'll set boots to spawn at 2x the base rate (e.g., 1600ms if base is 800ms)
            bootInterval = setInterval(() => spawnEntity('boot'), baseRate * 2.5);

            // 2. FISH: Rates fluctuate based on Season and Pond
            let fishRate;
            switch(season) {
                case 'summer': fishRate = baseRate * 0.8; break; // Constant Fast
                case 'winter': fishRate = baseRate * 4.0; break; // Constant Slow
                case 'spring': 
                    // Gets FASTER per pond (e.g. 3s -> 2.2s -> 1.4s -> 0.6s)
                    fishRate = Math.max(baseRate * 0.6, (baseRate * 4) - (currentPond * (baseRate * 0.8)));
                    break;
                case 'fall': 
                    // Gets SLOWER per pond
                    fishRate = Math.min(baseRate * 5, (baseRate * 0.6) + (currentPond * (baseRate * 0.8)));
                    break;
                default: // Manual Mode
                    const ratio = parseInt(document.getElementById('param-ratio').value);
                    fishRate = baseRate * (1 + (ratio/50)); 
            }
            fishInterval = setInterval(() => spawnEntity('fish'), fishRate);
        }

        function spawnEntity(type) {
            if (!gameActive) return;
            const entity = document.createElement('div');
            entity.classList.add('entity');
            entity.style.backgroundImage = (type === 'boot') ? "url('boot.png')" : "url('fish.png')";

            const maxX = document.getElementById('game-container').clientWidth - 100;
            const maxY = document.getElementById('game-container').clientHeight - 100;
            entity.style.left = Math.random() * maxX + 50 + 'px';
            entity.style.top = Math.random() * maxY + 50 + 'px';

            entity.onpointerdown = (e) => {
                if(type === 'boot') {
                    document.getElementById('snd-sad').play();
                } else {
                    document.getElementById('snd-happy').play();
                    score += 10; fishCaughtInPond++;
                    checkPondStatus();
                }
                updateHUD();
                entity.remove();
            };
            document.getElementById('game-container').appendChild(entity);
            setTimeout(() => { if(entity.parentNode) entity.remove(); }, 2000);
        }

        function checkPondStatus() {
            const max = parseInt(document.getElementById('param-max-fish').value);
            if (fishCaughtInPond >= max) {
                clearInterval(fishInterval);
                clearInterval(bootInterval);
                showOverlay("Pond is Empty!", `You caught ${fishCaughtInPond} fish. Time to move!`, true);
            }
        }

        function manualTravel() {
            if(!gameActive) return;
            clearInterval(fishInterval); clearInterval(bootInterval);
            document.querySelectorAll('.entity').forEach(e => e.remove());
            nextPond(); // Go straight to travel logic
        }

        function nextPond() {
            currentPond++;
            fishCaughtInPond = 0;
            updateHUD();
            
            const travelTime = parseInt(document.getElementById('param-travel').value) * 1000;
            
            showOverlay("Traveling...", "", false);
            document.getElementById('transition-gif').style.display = 'block';
            document.getElementById('loading-bar-container').style.display = 'block';

            const bar = document.getElementById('loading-bar-fill');
            bar.style.transition = 'none'; bar.style.width = '0%';
            void bar.offsetWidth;
            bar.style.transition = `width ${travelTime}ms linear`;
            bar.style.width = '100%';

            setTimeout(() => {
                if(!gameActive) return;
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('transition-gif').style.display = 'none';
                document.getElementById('loading-bar-container').style.display = 'none';
                startSpawner();
            }, travelTime);
        }

        function gameLoop() {
            timeLeft--; updateHUD();
            if (timeLeft <= 0) {
                stopGame();
                showOverlay("Experiment Complete", `Total Score: ${score}`, false);
                document.getElementById('close-overlay-btn').style.display = 'block';
            }
        }

        function updateHUD() {
            document.getElementById('score').innerText = score;
            document.getElementById('pond-count').innerText = currentPond;
            let m = Math.floor(timeLeft / 60), s = timeLeft % 60;
            document.getElementById('timer').innerText = `${m}:${s<10?'0':''}${s}`;
        }

        function showOverlay(title, desc, showBtn) {
            document.getElementById('overlay-title').innerText = title;
            document.getElementById('overlay-desc').innerText = desc;
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('next-pond-btn').style.display = showBtn ? 'inline-block' : 'none';
        }

        function closeOverlay() { document.getElementById('overlay').style.display = 'none'; }
    </script>
</body>
</html>

